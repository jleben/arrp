module osc;

phase(freq) = p where
{
    p =
    [
        0 -> 0.0;
        t ->
        ## Breaks when using "this":
        ## let x = this[t-1] + freq[t-1] in
        let x = p[t-1] + freq[t-1] in
            if x < 1 then x else x - 1
    ];
};

pi = atan(1) * 4;

osc(freq) = sin(phase(freq) * 2 * pi);

output main = osc(0.1);

##? [~]real64
##? 0.00000
##? 0.587785
##? 0.951057
##? 0.951057
##? 0.587785
##? 0.000000
##? -0.587785
##? -0.951057
##? -0.951057
##? -0.587785
##? -0.000000
##? 0.587785
##? 0.951057
##? 0.951057
##? 0.587785
##? 0.000000
